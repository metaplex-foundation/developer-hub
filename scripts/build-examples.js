#!/usr/bin/env node

/**
 * Build script that reads native code files and generates example index.js files
 * with the code inlined as string literals. This solves the SSR hydration issue.
 *
 * Run this script whenever you update the native example files:
 *   node scripts/build-examples.js
 */

const fs = require('fs')
const path = require('path')

// Find all example directories
const examplesDir = path.join(__dirname, '../src/examples')

/**
 * Parse code file and extract sections marked with [SECTION] comments
 * Supports: [IMPORTS], [SETUP], [MAIN], [OUTPUT]
 */
function parseCodeSections(code, isShell = false) {
  const sections = {
    imports: '',
    setup: '',
    main: '',
    output: '',
    full: code, // Always include full code
  }

  // For shell files, we don't parse sections - just use the full code
  if (isShell) {
    return sections
  }

  // Extract each section
  const importMatch = code.match(/\/\/ \[IMPORTS\]([\s\S]*?)\/\/ \[\/IMPORTS\]/)
  const setupMatch = code.match(/\/\/ \[SETUP\]([\s\S]*?)\/\/ \[\/SETUP\]/)
  const mainMatch = code.match(/\/\/ \[MAIN\]([\s\S]*?)\/\/ \[\/MAIN\]/)
  const outputMatch = code.match(/\/\/ \[OUTPUT\]([\s\S]*?)\/\/ \[\/OUTPUT\]/)

  if (importMatch) sections.imports = importMatch[1].trim()
  if (setupMatch) sections.setup = setupMatch[1].trim()
  if (mainMatch) sections.main = mainMatch[1].trim()
  if (outputMatch) sections.output = outputMatch[1].trim()

  return sections
}

function processExampleDirectory(dir) {
  const indexPath = path.join(dir, 'index.js')

  // Check if this directory has native files
  const nativeFiles = {
    kit: { path: path.join(dir, 'kit.js'), isShell: false },
    umi: { path: path.join(dir, 'umi.js'), isShell: false },
    shank: { path: path.join(dir, 'shank.rs'), isShell: false },
    anchor: { path: path.join(dir, 'anchor.rs'), isShell: false },
    cli: { path: path.join(dir, 'cli.sh'), isShell: true },
  }

  const existingFiles = {}
  let hasNativeFiles = false

  for (const [key, fileInfo] of Object.entries(nativeFiles)) {
    if (fs.existsSync(fileInfo.path)) {
      const code = fs.readFileSync(fileInfo.path, 'utf-8')
      existingFiles[key] = parseCodeSections(code, fileInfo.isShell)
      hasNativeFiles = true
    }
  }

  if (!hasNativeFiles) {
    return // Skip directories without native files
  }

  // Read the existing index.js to extract metadata
  let metadata = {
    title: path.basename(dir),
    description: '',
    tags: [],
  }

  if (fs.existsSync(indexPath)) {
    const content = fs.readFileSync(indexPath, 'utf-8')
    const metadataMatch = content.match(/export const metadata = \{[\s\S]*?\}/)
    if (metadataMatch) {
      // Extract metadata values
      const titleMatch = content.match(/title: ['"](.+?)['"]/)
      const descMatch = content.match(/description: ['"](.+?)['"]/)
      const tagsMatch = content.match(/tags: \[(.*?)\]/)

      if (titleMatch) metadata.title = titleMatch[1]
      if (descMatch) metadata.description = descMatch[1]
      if (tagsMatch) {
        metadata.tags = tagsMatch[1]
          .split(',')
          .map(t => t.trim().replace(/['"]/g, ''))
          .filter(Boolean)
      }
    }
  }

  // Generate the new index.js content
  const lines = [
    '/**',
    ` * Example: ${metadata.title}`,
    ' *',
    ` * ${metadata.description}`,
    ' *',
    ' * This file is auto-generated by scripts/build-examples.js',
    ' * Edit the native .js and .rs files, then run: node scripts/build-examples.js',
    ' */',
    '',
  ]

  // Add code sections as constants
  for (const [key, sections] of Object.entries(existingFiles)) {
    const varName = `${key}Sections`
    lines.push(`const ${varName} = ${JSON.stringify(sections, null, 2)}`)
    lines.push('')
  }

  // Add metadata export
  lines.push('export const metadata = {')
  lines.push(`  title: ${JSON.stringify(metadata.title)},`)
  lines.push(`  description: ${JSON.stringify(metadata.description)},`)
  lines.push(`  tags: [${metadata.tags.map(t => `'${t}'`).join(', ')}],`)
  lines.push('}')
  lines.push('')

  // Add examples export
  lines.push('export const examples = {')

  if (existingFiles.kit) {
    lines.push('  kit: {')
    lines.push("    framework: 'Kit',")
    lines.push("    language: 'javascript',")
    lines.push('    code: kitSections.full,')
    lines.push('    sections: kitSections,')
    lines.push('  },')
    lines.push('')
  }

  if (existingFiles.umi) {
    lines.push('  umi: {')
    lines.push("    framework: 'Umi',")
    lines.push("    language: 'javascript',")
    lines.push('    code: umiSections.full,')
    lines.push('    sections: umiSections,')
    lines.push('  },')
    lines.push('')
  }

  if (existingFiles.shank) {
    lines.push('  shank: {')
    lines.push("    framework: 'Shank',")
    lines.push("    language: 'rust',")
    lines.push('    code: shankSections.full,')
    lines.push('    sections: shankSections,')
    lines.push('  },')
    lines.push('')
  }

  if (existingFiles.anchor) {
    lines.push('  anchor: {')
    lines.push("    framework: 'Anchor',")
    lines.push("    language: 'rust',")
    lines.push('    code: anchorSections.full,')
    lines.push('    sections: anchorSections,')
    lines.push('  },')
    lines.push('')
  }

  if (existingFiles.cli) {
    lines.push('  cli: {')
    lines.push("    framework: 'CLI',")
    lines.push("    language: 'bash',")
    lines.push('    code: cliSections.full,')
    lines.push('    sections: cliSections,')
    lines.push('  },')
  }

  lines.push('}')
  lines.push('')

  // Write the generated file
  fs.writeFileSync(indexPath, lines.join('\n'))
  console.log(`âœ“ Generated ${path.relative(examplesDir, indexPath)}`)
}

// Walk through all example directories
function walkDirectory(dir) {
  const entries = fs.readdirSync(dir, { withFileTypes: true })

  for (const entry of entries) {
    const fullPath = path.join(dir, entry.name)

    if (entry.isDirectory()) {
      // Check if this directory has an index.js or native files
      const hasIndexOrNative = fs.readdirSync(fullPath).some(file =>
        file === 'index.js' || file.endsWith('.js') || file.endsWith('.rs') || file.endsWith('.sh')
      )

      if (hasIndexOrNative) {
        processExampleDirectory(fullPath)
      }

      // Recurse into subdirectories
      walkDirectory(fullPath)
    }
  }
}

console.log('Building example files...\n')
walkDirectory(examplesDir)
console.log('\nDone!')
